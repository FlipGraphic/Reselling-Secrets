<!-- Helper Functions - Header Section: RS Full Send List Popup (Multi-Level Filter Final Build) -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RS – Full Send List</title>
<style>
  :root {
    --bg:#0c0f10;--panel:#111417;--border:#1f2a30;--text:#e8f1f2;
    --muted:#a8b3b8;--accent:#10d1c6;--accent-2:#0aa29a;--shadow:0 20px 50px rgba(0,0,0,.6);
  }
  html,body{height:100%;margin:0;background:radial-gradient(1200px 600px at 50% -10%,rgba(16,209,198,.08),transparent 60%),var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
  .wrap{min-height:100%;display:grid;place-items:center;padding:24px}
  .cta-btn{border:0;border-radius:16px;padding:14px 20px;font-weight:800;letter-spacing:.3px;background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#021515;cursor:pointer;box-shadow:0 6px 18px rgba(10,162,154,.35);transition:transform .15s ease,box-shadow .2s ease}
  .cta-btn:hover{transform:translateY(-1px);box-shadow:0 10px 28px rgba(16,209,198,.35)}
  .popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.98);opacity:0;pointer-events:none;width:min(1000px,92vw);height:min(78vh,860px);background:linear-gradient(180deg,#0d1113,#0a0d0f);border:1px solid var(--border);border-radius:20px;box-shadow:var(--shadow);display:flex;flex-direction:column;overflow:hidden;transition:opacity .2s ease,transform .2s ease;resize:both;}
  .popup.show{opacity:1;transform:translate(-50%,-50%) scale(1);pointer-events:auto}
  .popup:focus{outline:none}
  .popup.dragging{transition:none}
  .pop-header{display:flex;align-items:center;gap:14px;padding:14px 16px;background:linear-gradient(180deg,rgba(16,209,198,.08),rgba(16,209,198,.03));border-bottom:1px solid var(--border);cursor:move;user-select:none}
  .logo{width:34px;height:34px;object-fit:contain;filter:drop-shadow(0 0 10px rgba(16,209,198,.45))}
  .title{font-weight:900;letter-spacing:.6px}
  .close{margin-left:auto;display:inline-grid;place-items:center;width:36px;height:36px;border-radius:10px;background:#12181b;border:1px solid var(--border);color:var(--text);cursor:pointer}
  .toolbar{display:flex;gap:10px;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);background:#0c1113;flex-wrap:wrap}
  .search{flex:1;display:flex;gap:10px;min-width:200px;align-items:center;flex-wrap:wrap}
  .search input,.search select{height:40px;border-radius:12px;border:1px solid var(--border);background:#0b0f12;color:var(--text);padding:0 12px}
  .search input{flex:1;min-width:160px}
  .stats{font-size:12px;color:var(--muted)}
  .table-wrap{flex:1;overflow:auto;background:radial-gradient(800px 400px at 50% 0%,rgba(16,209,198,.05),transparent 60%)}
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:auto}
  thead th{position:sticky;top:0;background:#0d1316;padding:10px 8px;border-bottom:1px solid var(--border);text-align:left;font-size:12px;color:#b7c4c8;font-weight:700;letter-spacing:.4px}
  thead th:nth-child(1){width:15%}
  thead th:nth-child(2){width:15%}
  thead th:nth-child(3){width:auto}
  thead th:nth-child(4){width:10%}
  tbody td{padding:8px 10px;border-bottom:1px solid #131a1d;white-space:nowrap;vertical-align:middle;font-size:13px;text-overflow:ellipsis;overflow:hidden}
  tbody tr:hover{background:rgba(16,209,198,.04)}
  .col-title{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .no-results{padding:28px;text-align:center;color:var(--muted)}
  .glow{height:1px;background:linear-gradient(90deg,transparent,rgba(16,209,198,.45),transparent)}
  tbody td:nth-child(2){text-transform:uppercase}
  @media(max-width:700px){
    .popup{width:95vw;height:80vh}
    .search select,.search input{flex:1 1 100%}
    thead th,tbody td{font-size:11px;padding:6px}
  }
</style>
</head>
<body>
<div class="wrap"><button class="cta-btn" id="openRS">Open RS List</button></div>

<div class="popup" id="rsPopup" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="dialogTitle" tabindex="-1">
  <div class="pop-header" id="dragHandle">
    <img class="logo" src="https://i.imgur.com/XpaaWI4.png" alt="RS" />
    <div class="title" id="dialogTitle">RS – Full Send List</div>
    <button class="close" id="closeRS" type="button" aria-label="Close">✕</button>
  </div>

  <div class="toolbar">
    <div class="search">
      <select id="catSelect"><option value="">All Categories</option></select>
      <select id="storeSelect"><option value="">All Stores</option></select>
      <input id="searchInput" type="text" placeholder="Type to filter…" />
    </div>
    <div class="stats" id="stats" aria-live="polite" aria-atomic="true">Loading…</div>
  </div>

  <div class="glow"></div>
  <div class="table-wrap">
    <table>
      <thead><tr><th>Store</th><th>SKU</th><th>Product Title</th><th>Comps</th></tr></thead>
      <tbody id="tbody"><tr><td colspan="4" class="no-results">Waiting for data…</td></tr></tbody>
    </table>
  </div>
</div>

<script>
(() => {
  const SHEET_JSON_URL='https://script.google.com/macros/s/AKfycbxBmoyredIJsZwHkg6jt_FUc_WLy94x3TvpXxESfUKVX9OXfopRM2grHXeqPgXLPfvV2g/exec';
  const openBtn=document.getElementById('openRS'),
        popup=document.getElementById('rsPopup'),
        closeBtn=document.getElementById('closeRS'),
        handle=document.getElementById('dragHandle'),
        tbody=document.getElementById('tbody'),
        stats=document.getElementById('stats'),
        searchInput=document.getElementById('searchInput'),
        catSelect=document.getElementById('catSelect'),
        storeSelect=document.getElementById('storeSelect');
  let rawRows=[],uniqueCats=[],uniqueStores=[];
  let lastFocused=null; // track last focused element to restore on close

  const focusableSelectors='a[href],button:not([disabled]),input,select,textarea,[tabindex]:not([tabindex="-1"])';

  function isHttpUrl(u){
    try{const url=new URL(u);return url.protocol==='http:'||url.protocol==='https:';}catch{return false}
  }

  async function loadData(){
    stats.textContent='Loading…';
    stats.setAttribute('aria-busy','true');
    try{
      const res=await fetch(SHEET_JSON_URL,{cache:'no-store'});
      if(!res.ok) throw new Error('Failed to fetch: '+res.status);
      const rows=await res.json();
      if(!Array.isArray(rows) || rows.length===0){
        throw new Error('No data returned');
      }
      const header=rows.shift();
      const idx={
        store:header.findIndex(h=>/store/i.test(h)&&!/header/i.test(h)),
        sku:header.findIndex(h=>/sku|upc/i.test(h)),
        title:header.findIndex(h=>/title/i.test(h)),
        link:header.findIndex(h=>/link/i.test(h)),
        comps:header.findIndex(h=>/comps/i.test(h)),
        category:header.findIndex(h=>/^category$/i.test(h)),
        catHeader:header.findIndex(h=>/category\s*header/i.test(h))
      };
      rawRows=rows.filter(r=>{
        const storeVal=idx.store>-1?r[idx.store]:'';
        const titleVal=idx.title>-1?r[idx.title]:'';
        return storeVal||titleVal;
      }).map(r=>({
        store:idx.store>-1?(r[idx.store]||''):'',
        link:idx.link>-1?(r[idx.link]||''):'',
        sku:idx.sku>-1?(r[idx.sku]||''):'',
        title:idx.title>-1?(r[idx.title]||''):'',
        comps:String(idx.comps>-1?(r[idx.comps]??''):'')||'',
        category:idx.category>-1?(r[idx.category]||''):''
      }));
      const fromData=[...new Set(rawRows.map(r=>r.category).filter(Boolean))];
      const fromHeader=idx.catHeader>-1?rows.map(r=>r[idx.catHeader]).filter(Boolean):[];
      uniqueCats=[...new Set([...fromData,...fromHeader])].sort();
      // rebuild category options safely
      const prevCatVal=catSelect.value;
      catSelect.innerHTML='';
      const allOpt=document.createElement('option');
      allOpt.value='';
      allOpt.textContent='All Categories';
      catSelect.appendChild(allOpt);
      uniqueCats.forEach(c=>{
        const opt=document.createElement('option');
        opt.value=c; opt.textContent=c; if(prevCatVal&&prevCatVal===c) opt.selected=true; catSelect.appendChild(opt);
      });
      updateStoreList();
      render(rawRows);
      stats.textContent=`${rawRows.length} items`;
    }catch(e){
      console.error(e);
      tbody.innerHTML='<tr><td colspan="4" class="no-results">Failed to load data</td></tr>';
      stats.textContent='Load error';
    } finally {
      stats.removeAttribute('aria-busy');
    }
  }

  function normalize(v){return String(v||'').toLowerCase();}
  function updateStoreList(){
    const selectedCat=normalize(catSelect.value);
    const stores=rawRows.filter(r=>!selectedCat||normalize(r.category)===selectedCat).map(r=>r.store).filter(Boolean);
    uniqueStores=[...new Set(stores)].sort();
    const prevStoreVal=storeSelect.value;
    storeSelect.innerHTML='';
    const allOpt=document.createElement('option');
    allOpt.value=''; allOpt.textContent='All Stores';
    storeSelect.appendChild(allOpt);
    uniqueStores.forEach(s=>{
      const opt=document.createElement('option');
      opt.value=s; opt.textContent=s; if(prevStoreVal&&prevStoreVal===s) opt.selected=true; storeSelect.appendChild(opt);
    });
  }

  function filterRows(){
    const catVal=normalize(catSelect.value),
          storeVal=normalize(storeSelect.value),
          q=normalize(searchInput.value);
    const filtered=rawRows.filter(r=>{
      if(catVal && normalize(r.category)!==catVal) return false;
      if(storeVal && normalize(r.store)!==storeVal) return false;
      if(q && !(normalize(r.title).includes(q)||normalize(r.sku).includes(q)||normalize(r.comps).includes(q))) return false;
      return true;
    });
    render(filtered);
    stats.textContent=`${filtered.length} shown of ${rawRows.length}`;
  }

  function render(rows){
    if(!rows.length){tbody.innerHTML='<tr><td colspan="4" class="no-results">No results found</td></tr>';return;}
    tbody.innerHTML='';
    const frag=document.createDocumentFragment();
    rows.forEach(r=>{
      const tr=document.createElement('tr');

      // Store
      const tdStore=document.createElement('td');
      if(r.link && isHttpUrl(r.link)){
        const a=document.createElement('a');
        a.href=r.link; a.target='_blank'; a.rel='noopener noreferrer';
        a.textContent=r.store; a.style.color='var(--accent)'; a.style.textDecoration='none';
        tdStore.appendChild(a);
      }else{
        tdStore.textContent=r.store;
      }
      tr.appendChild(tdStore);

      // SKU
      const tdSku=document.createElement('td');
      tdSku.textContent=r.sku; tr.appendChild(tdSku);

      // Title
      const tdTitle=document.createElement('td');
      tdTitle.className='col-title'; tdTitle.title=r.title; tdTitle.textContent=r.title; tr.appendChild(tdTitle);

      // Comps
      const tdComps=document.createElement('td');
      if(r.comps && isHttpUrl(r.comps)){
        const a=document.createElement('a');
        a.href=r.comps; a.target='_blank'; a.rel='noopener noreferrer'; a.textContent='Open'; a.style.color='var(--accent)';
        tdComps.appendChild(a);
      }else{
        tdComps.textContent=r.comps;
      }
      tr.appendChild(tdComps);

      frag.appendChild(tr);
    });
    tbody.appendChild(frag);
  }

  // Drag logic (avoid transform conflicts)
  let dragging=false,sx,sy,sl,st;
  handle.onmousedown=e=>{
    if(e.target.closest('button'))return;
    dragging=true; sx=e.clientX; sy=e.clientY;
    const rect=popup.getBoundingClientRect(); sl=rect.left; st=rect.top;
    popup.classList.add('dragging');
    popup.style.transform='none';
    document.body.style.userSelect='none';
  };
  window.onmousemove=e=>{
    if(!dragging) return;
    popup.style.left=sl+e.clientX-sx+'px';
    popup.style.top=st+e.clientY-sy+'px';
  };
  window.onmouseup=()=>{dragging=false;popup.classList.remove('dragging');document.body.style.userSelect='';};

  function openDialog(){
    lastFocused=document.activeElement;
    // reset to centered state for consistent animation
    popup.style.left=''; popup.style.top=''; popup.style.transform=''; popup.classList.remove('dragging');
    popup.classList.add('show');
    popup.setAttribute('aria-hidden','false');
    if(!rawRows.length) loadData();
    // focus first focusable
    const focusables=popup.querySelectorAll(focusableSelectors);
    const first=focusables[0];
    (first||popup).focus();
  }
  function closeDialog(){
    popup.classList.remove('show');
    popup.setAttribute('aria-hidden','true');
    if(lastFocused && typeof lastFocused.focus==='function') lastFocused.focus();
  }

  openBtn.onclick=openDialog;
  closeBtn.onclick=closeDialog;

  // keyboard: Escape to close, Tab trap
  popup.addEventListener('keydown',e=>{
    if(e.key==='Escape'){ e.preventDefault(); closeDialog(); return; }
    if(e.key==='Tab'){
      const focusables=[...popup.querySelectorAll(focusableSelectors)].filter(el=>el.offsetParent!==null);
      if(focusables.length===0){ e.preventDefault(); return; }
      const first=focusables[0], last=focusables[focusables.length-1];
      if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
      else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
    }
  });

  catSelect.onchange=()=>{updateStoreList();filterRows();};
  storeSelect.onchange=filterRows;
  searchInput.oninput=filterRows;
})();
</script>
</body>
</html>
